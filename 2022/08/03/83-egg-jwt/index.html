<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>83ã€egg-jwtç”¨æˆ·é‰´æƒã€æ³¨å†Œã€ç™»å½•åŠä¸­é—´ä»¶</title><meta name="description" content="ğŸ¯ ğŸ¯ ğŸ¯ ğŸ¯ ğŸ¯"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="

ä¸€ã€egg-jwtå®ç°ç”¨æˆ·é‰´æƒ
ç”¨æˆ·é‰´æƒï¼Œä¸€ç§ç”¨äºåœ¨é€šä¿¡ç½‘ç»œä¸­å¯¹è¯•å›¾è®¿é—®æ¥è‡ªæœåŠ¡æä¾›å•†çš„æœåŠ¡çš„ç”¨æˆ·è¿›è¡Œé‰´æƒçš„æ–¹æ³•ã€‚ç”¨äºç”¨æˆ·ç™»é™†åˆ°DSMPæˆ–ä½¿ç”¨æ•°æ®ä¸šåŠ¡æ—¶ï¼Œä¸šåŠ¡ç½‘å…³æˆ–Portalå‘é€æ­¤æ¶ˆæ¯åˆ°DSMPï¼Œå¯¹è¯¥ç”¨æˆ·ä½¿ç”¨æ•°æ®ä¸šåŠ¡çš„åˆæ³•æ€§å’Œæœ‰æ•ˆæ€§ï¼ˆçŠ¶æ€æ˜¯å¦ä¸ºæ¿€æ´»ï¼‰è¿›è¡Œæ£€æŸ¥ã€‚

ç®€å•ç†è§£ï¼Œé‰´æƒå°±æ˜¯ç”¨æˆ·åœ¨æµè§ˆç½‘é¡µæˆ– App æ—¶ï¼Œé€šè¿‡çº¦å®šå¥½çš„æ–¹å¼ï¼Œè®©ç½‘é¡µå’Œç”¨æˆ·å»ºç«‹èµ·ä¸€ç§ç›¸äº’ä¿¡èµ–çš„æœºåˆ¶ï¼Œç»§è€Œè¿”å›ç»™ç”¨æˆ·éœ€è¦çš„ä¿¡æ¯ã€‚
é‰´æƒçš„æœºåˆ¶ï¼š

HTTP Basic Authentication
session-cookie
Token ä»¤ç‰Œ
OAuth(å¼€æ”¾æˆæƒ)

token å¯ä»¥è¿ç”¨åœ¨å¦‚ç½‘é¡µã€å®¢æˆ·ç«¯ã€å°ç¨‹åºã€æµè§ˆå™¨æ’ä»¶ç­‰ç­‰é¢†åŸŸã€‚å¦‚æœé€‰ç”¨ cookie çš„å½¢å¼é‰´æƒï¼Œåœ¨å®¢æˆ·ç«¯å’Œå°ç¨‹åºå°±æ— æ³•ä½¿ç”¨è¿™å¥—æ¥å£ï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰åŸŸçš„æ¦‚å¿µï¼Œè€Œ cook.."><meta name="generator" content="Hexo 5.4.1"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Jude's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">83ã€egg-jwtç”¨æˆ·é‰´æƒã€æ³¨å†Œã€ç™»å½•åŠä¸­é—´ä»¶</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">ç‚¹å‡»è¿”å›é¡¶éƒ¨</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">é¦–é¡µ</a></h3><h3 class="is-inline-block"><a href="/about">å…³äº</a></h3><h3 class="is-inline-block"><a href="/archives">å½’æ¡£</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">é¦–é¡µ</a></h3><h3 class="is-inline-block"><a href="/about">å…³äº</a></h3><h3 class="is-inline-block"><a href="/archives">å½’æ¡£</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81egg-jwt%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E9%89%B4%E6%9D%83"><span class="toc-text">ä¸€ã€egg-jwtå®ç°ç”¨æˆ·é‰´æƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3"><span class="toc-text">äºŒã€æ³¨å†Œæ¥å£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3"><span class="toc-text">ä¸‰ã€ç™»å½•æ¥å£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-text">å››ã€ç™»å½•éªŒè¯ä¸­é—´ä»¶</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/egg"><i class="tag post-item-tag">egg</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">83ã€egg-jwtç”¨æˆ·é‰´æƒã€æ³¨å†Œã€ç™»å½•åŠä¸­é—´ä»¶</h1><time class="has-text-grey" datetime="2022-08-03T14:00:00.000Z">2022-08-03</time><article class="mt-2 post-content"><span id="more"></span>

<h2 id="ä¸€ã€egg-jwtå®ç°ç”¨æˆ·é‰´æƒ"><a href="#ä¸€ã€egg-jwtå®ç°ç”¨æˆ·é‰´æƒ" class="headerlink" title="ä¸€ã€egg-jwtå®ç°ç”¨æˆ·é‰´æƒ"></a>ä¸€ã€egg-jwtå®ç°ç”¨æˆ·é‰´æƒ</h2><blockquote>
<p>ç”¨æˆ·é‰´æƒï¼Œä¸€ç§ç”¨äºåœ¨é€šä¿¡ç½‘ç»œä¸­å¯¹è¯•å›¾è®¿é—®æ¥è‡ªæœåŠ¡æä¾›å•†çš„æœåŠ¡çš„ç”¨æˆ·è¿›è¡Œé‰´æƒçš„æ–¹æ³•ã€‚ç”¨äºç”¨æˆ·ç™»é™†åˆ°DSMPæˆ–ä½¿ç”¨æ•°æ®ä¸šåŠ¡æ—¶ï¼Œä¸šåŠ¡ç½‘å…³æˆ–Portalå‘é€æ­¤æ¶ˆæ¯åˆ°DSMPï¼Œå¯¹è¯¥ç”¨æˆ·ä½¿ç”¨æ•°æ®ä¸šåŠ¡çš„åˆæ³•æ€§å’Œæœ‰æ•ˆæ€§ï¼ˆçŠ¶æ€æ˜¯å¦ä¸ºæ¿€æ´»ï¼‰è¿›è¡Œæ£€æŸ¥ã€‚</p>
</blockquote>
<p>ç®€å•ç†è§£ï¼Œé‰´æƒå°±æ˜¯ç”¨æˆ·åœ¨æµè§ˆç½‘é¡µæˆ– <code>App</code> æ—¶ï¼Œé€šè¿‡çº¦å®šå¥½çš„æ–¹å¼ï¼Œè®©ç½‘é¡µå’Œç”¨æˆ·å»ºç«‹èµ·ä¸€ç§ç›¸äº’ä¿¡èµ–çš„æœºåˆ¶ï¼Œç»§è€Œè¿”å›ç»™ç”¨æˆ·éœ€è¦çš„ä¿¡æ¯ã€‚</p>
<p>é‰´æƒçš„æœºåˆ¶ï¼š</p>
<ul>
<li>HTTP Basic Authentication</li>
<li>session-cookie</li>
<li>Token ä»¤ç‰Œ</li>
<li>OAuth(å¼€æ”¾æˆæƒ)</li>
</ul>
<p><code>token</code> å¯ä»¥è¿ç”¨åœ¨å¦‚ç½‘é¡µã€å®¢æˆ·ç«¯ã€å°ç¨‹åºã€æµè§ˆå™¨æ’ä»¶ç­‰ç­‰é¢†åŸŸã€‚å¦‚æœé€‰ç”¨ <code>cookie</code> çš„å½¢å¼é‰´æƒï¼Œåœ¨å®¢æˆ·ç«¯å’Œå°ç¨‹åºå°±æ— æ³•ä½¿ç”¨è¿™å¥—æ¥å£ï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰åŸŸçš„æ¦‚å¿µï¼Œè€Œ <code>cookie</code> æ˜¯éœ€è¦å­˜åœ¨æŸä¸ªåŸŸä¸‹ã€‚</p>
<h2 id="äºŒã€æ³¨å†Œæ¥å£"><a href="#äºŒã€æ³¨å†Œæ¥å£" class="headerlink" title="äºŒã€æ³¨å†Œæ¥å£"></a>äºŒã€æ³¨å†Œæ¥å£</h2><p>åœ¨ <code>controller</code> ç›®å½•ä¸‹æ–°å»º <code>user.js</code> ç”¨äºç¼–å†™ç”¨æˆ·ç›¸å…³çš„ä»£ç </p>
<pre><code class="js">// controller/user.js
&#39;use strict&#39;;

const Controller = require(&#39;egg&#39;).Controller;

class UserController extends Controller &#123;
  async register() &#123;
    const &#123; ctx &#125; = this;
    const &#123; username, password &#125; = ctx.request.body; // è·å–æ³¨å†Œéœ€è¦çš„å‚æ•°
  &#125;
&#125;

module.exports = UserController;
</code></pre>
<p>æ­¤æ—¶æˆ‘ä»¬æ‹¿åˆ°äº† <code>username</code> å’Œ <code>password</code>ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸¤ä¸ªå‚æ•°æ˜¯å¦ä¸ºç©ºã€‚å¦‚æœæ˜¯ç©ºï¼Œåˆ™è¿”å›é”™è¯¯ä¿¡æ¯ï¼š</p>
<pre><code class="js">// åˆ¤ç©ºæ“ä½œ
if (!username || !password) &#123;
  ctx.body = &#123;
    code: 500,
    msg: &#39;è´¦å·å¯†ç ä¸èƒ½ä¸ºç©º&#39;,
    data: null
  &#125;
  return
&#125;
</code></pre>
<p>æ­¤æ—¶æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªåˆ¤æ–­ï¼Œæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„ <code>username</code> å»æ•°æ®åº“çš„ <code>user</code> è¡¨æŸ¥è¯¢ï¼Œæ˜¯å¦å·²ç»è¢«æ³¨å†Œã€‚</p>
<p>åœ¨ <code>service</code> ç›®å½•ä¸‹æ–°å»º <code>user.js</code>ï¼Œå¹¶ä¸”æ·»åŠ  <code>getUserByName</code> æ–¹æ³•ç”¨äºæ ¹æ® <code>username</code> æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯</p>
<pre><code class="js">//  service/user.js
&#39;use strict&#39;;

const Service = require(&#39;egg&#39;).Service;

class UserService extends Service &#123;
  // é€šè¿‡ç”¨æˆ·åè·å–ç”¨æˆ·ä¿¡æ¯
  async getUserByName(username) &#123;
    const &#123; app &#125; = this;
      try &#123;
        const result = await app.mysql.get(&#39;user&#39;, &#123; username &#125;);
        return result;
      &#125; catch (error) &#123;
        console.log(error);
        return null;
      &#125;
  &#125;
&#125;
module.exports = UserService;
</code></pre>
<blockquote>
<p>ä½¿ç”¨ async å’Œ await æ—¶ï¼Œå¦‚æœæƒ³æ•è·é”™è¯¯ï¼Œéœ€è¦ä½¿ç”¨ tryâ€¦catch æ¥æ•è·ï¼Œå¦‚æœä»£ç è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œéƒ½å°†ä¼šè¢« catch æ•è·ã€‚</p>
</blockquote>
<p> <code>controller/user.js</code> ç»§ç»­æ·»åŠ é€»è¾‘ï¼Œåœ¨ ã€Œåˆ¤ç©ºæ“ä½œã€é€»è¾‘ä¸‹ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»è¢«æ³¨å†Œçš„é€»è¾‘ï¼š</p>
<pre><code class="js">// controller/user.js
async register() &#123;
  ...
  // éªŒè¯æ•°æ®åº“å†…æ˜¯å¦å·²ç»æœ‰è¯¥è´¦æˆ·å
  const userInfo = await ctx.service.user.getUserByName(username) // è·å–ç”¨æˆ·ä¿¡æ¯

  // åˆ¤æ–­æ˜¯å¦å·²ç»å­˜åœ¨
  if (userInfo &amp;&amp; userInfo.id) &#123;
    ctx.body = &#123;
      code: 500,
      msg: &#39;è´¦æˆ·åå·²è¢«æ³¨å†Œï¼Œè¯·é‡æ–°è¾“å…¥&#39;,
      data: null
    &#125;
    return
  &#125;
&#125;
</code></pre>
<p>ç»è¿‡ä¸Šè¿°ä¸¤å±‚åˆ¤æ–­ä¹‹åï¼Œæ¥ä¸‹ä¾¿å¯å°†è´¦å·å’Œå¯†ç å†™å…¥æ•°æ®åº“</p>
<pre><code class="js">// controller/user.js
// é»˜è®¤å¤´åƒï¼Œæ”¾åœ¨ user.js çš„æœ€å¤–ï¼Œéƒ¨é¿å…é‡å¤å£°æ˜ã€‚
const defaultAvatar = &#39;http://s.yezgea02.com/1615973940679/WeChat77d6d2ac093e247c361f0b8a7aeb6c2a.png&#39;
// è°ƒç”¨ service æ–¹æ³•ï¼Œå°†æ•°æ®å­˜å…¥æ•°æ®åº“ã€‚
const result = await ctx.service.user.register(&#123;
  username,
  password,
  signature: &#39;ä¸–ç•Œå’Œå¹³ã€‚&#39;,
  avatar: defaultAvatar
&#125;);

if (result) &#123;
  ctx.body = &#123;
    code: 200,
    msg: &#39;æ³¨å†ŒæˆåŠŸ&#39;,
    data: null
  &#125;
&#125; else &#123;
  ctx.body = &#123;
    code: 500,
    msg: &#39;æ³¨å†Œå¤±è´¥&#39;,
    data: null
  &#125;
&#125;
</code></pre>
<p><code>service/user.js</code> æ·»åŠ  <code>register</code> å†™å…¥æ•°æ®åº“çš„æ–¹æ³•</p>
<pre><code class="js">// service/user.js
...
// æ³¨å†Œ
async register(params) &#123;
  const &#123; app &#125; = this;
  try &#123;
    const result = await app.mysql.insert(&#39;user&#39;, params);
    return result;
  &#125; catch (error) &#123;
    console.log(error);
    return null;
  &#125;
&#125;
</code></pre>
<p>åœ¨ <code>router.js</code> å°†æ¥å£æŠ›å‡º</p>
<pre><code class="js">// router.js
&#39;use strict&#39;;

/**
 * @param &#123;Egg.Application&#125; app - egg application
 */
module.exports = app =&gt; &#123;
  const &#123; router, controller &#125; = app;
  router.post(&#39;/api/user/register&#39;, controller.user.register);
&#125;;
</code></pre>
<p>é€šè¿‡postmanå·¥å…·æµ‹è¯•æ¥å£ã€‚</p>
<h2 id="ä¸‰ã€ç™»å½•æ¥å£"><a href="#ä¸‰ã€ç™»å½•æ¥å£" class="headerlink" title="ä¸‰ã€ç™»å½•æ¥å£"></a>ä¸‰ã€ç™»å½•æ¥å£</h2><blockquote>
<p>é€šè¿‡æ³¨å†Œçš„ã€Œç”¨æˆ·åã€å’Œã€Œå¯†ç ã€ï¼Œè°ƒç”¨ç™»å½•æ¥å£ï¼Œæ¥å£ä¼šè¿”å›ç»™æˆ‘ä»¬ä¸€ä¸ª <code>token</code> ä»¤ç‰Œ</p>
</blockquote>
<p>æ¯æ¬¡å‘èµ·è¯·æ±‚ï¼Œæ— è®ºæ˜¯è·å–æ•°æ®ï¼Œè¿˜æ˜¯æäº¤æ•°æ®ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å°† <code>token</code> å¸¦ä¸Šï¼Œä»¥æ­¤æ¥æ ‡è¯†ï¼Œæ­¤æ¬¡è·å–(GET)æˆ–æäº¤(POST)æ˜¯å“ªä¸€ä¸ªç”¨æˆ·çš„è¡Œä¸ºã€‚</p>
<p> <code>egg-jwt</code> æœ‰åŠ å¯†çš„åŠŸèƒ½ï¼Œä¹Ÿæœ‰è§£å¯†çš„åŠŸèƒ½ã€‚é€šè¿‡è§£å¯† <code>token</code> æ‹¿åˆ°å½“åˆåŠ å¯† <code>token</code> æ—¶çš„ä¿¡æ¯ï¼Œä¿¡æ¯çš„å†…å®¹å¤§è‡´å°±æ˜¯å½“åˆæ³¨å†Œæ—¶å€™çš„ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>å®‰è£…egg-jwtæ’ä»¶</p>
<pre><code class="shell">npm i egg-jwt -S
</code></pre>
<p>Egg-jwtçš„<a href="https://link.juejin.cn/?target=https://github.com/okoala/egg-jwt%23readme">ä»“åº“åœ°å€</a></p>
<p>åœ¨ <code>config/plugin.js</code> ä¸‹æ·»åŠ æ’ä»¶ï¼š</p>
<pre><code class="js">jwt: &#123;
  enable: true,
  package: &#39;egg-jwt&#39;
&#125;
</code></pre>
<p><code>config/config.default.js</code> ä¸‹æ·»åŠ è‡ªå®šä¹‰åŠ å¯†å­—ç¬¦ä¸²</p>
<pre><code class="js">config.jwt = &#123;
  secret: &#39;YQ&#39;,
&#125;;
</code></pre>
<blockquote>
<p>secret<code>åŠ å¯†å­—ç¬¦ä¸²ï¼Œå°†åœ¨åç»­ç”¨äºç»“åˆç”¨æˆ·ä¿¡æ¯ç”Ÿæˆä¸€ä¸²</code>token</p>
</blockquote>
<p>åœ¨ <code>/controller/user.js</code> ä¸‹æ–°å»º <code>login</code> æ–¹æ³•</p>
<pre><code class="js">async login() &#123;
    // app ä¸ºå…¨å±€å±æ€§ï¼Œç›¸å½“äºæ‰€æœ‰çš„æ’ä»¶æ–¹æ³•éƒ½æ¤å…¥åˆ°äº† app å¯¹è±¡ã€‚
    const &#123; ctx, app &#125; = this;
    const &#123; username, password &#125; = ctx.request.body
    // æ ¹æ®ç”¨æˆ·åï¼Œåœ¨æ•°æ®åº“æŸ¥æ‰¾ç›¸å¯¹åº”çš„idæ“ä½œ
    const userInfo = await ctx.service.user.getUserByName(username)
    // æ²¡æ‰¾åˆ°è¯´æ˜æ²¡æœ‰è¯¥ç”¨æˆ·
    if (!userInfo || !userInfo.id) &#123;
      ctx.body = &#123;
        code: 500,
        msg: &#39;è´¦å·ä¸å­˜åœ¨&#39;,
        data: null
      &#125;
      return
    &#125;
    // æ‰¾åˆ°ç”¨æˆ·ï¼Œå¹¶ä¸”åˆ¤æ–­è¾“å…¥å¯†ç ä¸æ•°æ®åº“ä¸­ç”¨æˆ·å¯†ç ã€‚
    if (userInfo &amp;&amp; password != userInfo.password) &#123;
      ctx.body = &#123;
        code: 500,
        msg: &#39;è´¦å·å¯†ç é”™è¯¯&#39;,
        data: null
      &#125;
      return
    &#125;
       // ç”Ÿæˆ token åŠ ç›
      // app.jwt.sign æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªä¸ºå¯¹è±¡ï¼Œå¯¹è±¡å†…æ˜¯éœ€è¦åŠ å¯†çš„å†…å®¹ï¼›ç¬¬äºŒä¸ªæ˜¯åŠ å¯†å­—ç¬¦ä¸²ï¼Œä¸Šæ–‡å·²ç»æåˆ°è¿‡ã€‚
    const token = app.jwt.sign(&#123;
      id: userInfo.id,
      username: userInfo.username,
      exp: Math.floor(Date.now() / 1000) + (24 * 60 * 60) // token æœ‰æ•ˆæœŸä¸º 24 å°æ—¶
    &#125;, app.config.jwt.secret);

    ctx.body = &#123;
      code: 200,
      message: &#39;ç™»å½•æˆåŠŸ&#39;,
      data: &#123;
        token
      &#125;,
    &#125;;
&#125;
</code></pre>
<p>æŠŠè·å–åˆ°çš„ <code>userInfo</code> ä¸­çš„ <code>id</code> å’Œ <code>username</code> ä¸¤ä¸ªå±æ€§ï¼Œé€šè¿‡ <code>app.jwt.sign</code> æ–¹æ³•ï¼Œç»“åˆ <code>app.config.jwt.secret</code> åŠ å¯†å­—ç¬¦ä¸²ï¼ˆä¹‹å‰å£°æ˜çš„ <code>YQ</code>ï¼‰ï¼Œç”Ÿæˆä¸€ä¸ª <code>token</code>ã€‚è¿™ä¸ª <code>token</code> ä¼šæ˜¯ä¸€ä¸²å¾ˆé•¿çš„åŠ å¯†å­—ç¬¦ä¸²</p>
<p>åœ¨ <code>/controller/user.js</code> ä¸­ï¼Œæ–°å¢ä¸€ä¸ªéªŒè¯æ–¹æ³• <code>test</code></p>
<pre><code class="js">// éªŒè¯æ–¹æ³•
async test() &#123;
  const &#123; ctx, app &#125; = this;
  // é€šè¿‡ token è§£æï¼Œæ‹¿åˆ° user_id
  const token = ctx.request.header.authorization; // è¯·æ±‚å¤´è·å– authorization å±æ€§ï¼Œå€¼ä¸º token
  // é€šè¿‡ app.jwt.verify + åŠ å¯†å­—ç¬¦ä¸² è§£æå‡º token çš„å€¼ 
  const decode = await app.jwt.verify(token, app.config.jwt.secret);
  // å“åº”æ¥å£
  ctx.body = &#123;
    code: 200,
    message: &#39;è·å–æˆåŠŸ&#39;,
    data: &#123;
      ...decode
    &#125;
  &#125;
&#125;
</code></pre>
<p>åœ¨è·¯ç”± <code>router.js</code> è„šæœ¬ä¸­ï¼Œå°†ç™»å½•æ¥å£æŠ›å‡º</p>
<pre><code class="JS">&#39;use strict&#39;;

/**
 * @param &#123;Egg.Application&#125; app - egg application
 */
module.exports = app =&gt; &#123;
  const &#123; router, controller &#125; = app;
  router.post(&#39;/api/user/register&#39;, controller.user.register);
  router.post(&#39;/api/user/login&#39;, controller.user.login);
&#125;;
</code></pre>
<h2 id="å››ã€ç™»å½•éªŒè¯ä¸­é—´ä»¶"><a href="#å››ã€ç™»å½•éªŒè¯ä¸­é—´ä»¶" class="headerlink" title="å››ã€ç™»å½•éªŒè¯ä¸­é—´ä»¶"></a>å››ã€ç™»å½•éªŒè¯ä¸­é—´ä»¶</h2><p>ä¸­é—´ä»¶æˆ‘ä»¬å¯ä»¥ç†è§£æˆä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ <code>A</code>ã€<code>B</code>ã€<code>C</code>ã€<code>D</code> å››ä¸ªæ¥å£æ˜¯éœ€è¦ç”¨æˆ·æƒé™çš„ï¼Œå¦‚æœæˆ‘ä»¬è¦åˆ¤æ–­æ˜¯å¦æœ‰ç”¨æˆ·æƒé™çš„è¯ï¼Œå°±éœ€è¦åœ¨è¿™å››ä¸ªæ¥å£çš„æ§åˆ¶å±‚å»åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ã€‚</p>
<p>æ¯ä¸ªæ¥å£éƒ½éªŒè¯å­˜åœ¨çš„å¼Šç«¯</p>
<blockquote>
<p>1ã€æ¯æ¬¡ç¼–å†™æ–°çš„æ¥å£ï¼Œéƒ½è¦åœ¨æ–¹æ³•å†…éƒ¨åšåˆ¤æ–­ï¼Œè¿™å¾ˆè´¹äº‹ã€‚ 2ã€ä¸€æ—¦é‰´æƒæœ‰æ‰€è°ƒæ•´ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹æ¯ä¸ªç”¨åˆ°åˆ¤æ–­ç™»å½•çš„ä»£ç ã€‚</p>
</blockquote>
<p>åœ¨è¯·æ±‚æ¥å£çš„æ—¶å€™ï¼Œè¿‡ä¸€å±‚ä¸­é—´ä»¶ï¼Œåˆ¤æ–­è¯¥è¯·æ±‚æ˜¯å¦æ˜¯ç™»å½•çŠ¶æ€ä¸‹å‘èµ·çš„ã€‚æ­¤æ—¶æˆ‘ä»¬æ‰“å¼€é¡¹ç›®ï¼Œåœ¨ <code>app</code> ç›®å½•ä¸‹æ–°æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ <code>middleware</code>ï¼Œå¹¶ä¸”åœ¨è¯¥ç›®å½•ä¸‹æ–°å¢ <code>jwtErr.js</code></p>
<pre><code class="js">&#39;use strict&#39;;

module.exports = (secret) =&gt; &#123;
  return async function jwtErr(ctx, next) &#123;
    const token = ctx.request.header.authorization; // è‹¥æ˜¯æ²¡æœ‰ tokenï¼Œè¿”å›çš„æ˜¯ null å­—ç¬¦ä¸²
    let decode
    if(token != &#39;null&#39; &amp;&amp; token) &#123;
      try &#123;
        decode = ctx.app.jwt.verify(token, secret); // éªŒè¯token
        await next();
      &#125; catch (error) &#123;
        console.log(&#39;error&#39;, error)
        ctx.status = 200;
        ctx.body = &#123;
          msg: &#39;tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•&#39;,
          code: 401,
        &#125;
        return;
      &#125;
    &#125; else &#123;
      ctx.status = 200;
      ctx.body = &#123;
        code: 401,
        msg: &#39;tokenä¸å­˜åœ¨&#39;,
      &#125;;
      return;
    &#125;
  &#125;
&#125;
</code></pre>
<p>é¦–å…ˆä¸­é—´ä»¶é»˜è®¤æŠ›å‡ºä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªå¼‚æ­¥æ–¹æ³• <code>jwtErr</code>ï¼Œ<code>jewErr</code> æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•° <code>ctx</code> æ˜¯ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥åœ¨ <code>ctx</code> ä¸­æ‹¿åˆ°å…¨å±€å¯¹è±¡ <code>app</code>ã€‚</p>
<p>é¦–å…ˆï¼Œé€šè¿‡ <code>ctx.request.header.authorization</code> è·å–åˆ°è¯·æ±‚å¤´ä¸­çš„ <code>authorization</code> å±æ€§ï¼Œå®ƒä¾¿æ˜¯æˆ‘ä»¬è¯·æ±‚æ¥å£æ˜¯æºå¸¦çš„ <code>token</code> å€¼ï¼Œå¦‚æœæ²¡æœ‰æºå¸¦ <code>token</code>ï¼Œè¯¥å€¼ä¸ºå­—ç¬¦ä¸² <code>null</code>ã€‚æˆ‘ä»¬é€šè¿‡ <code>if</code> è¯­å¥åˆ¤æ–­å¦‚æœæœ‰ <code>token</code> çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <code>ctx.app.jwt.verify</code> æ–¹æ³•éªŒè¯è¯¥ <code>token</code> æ˜¯å¦å­˜åœ¨å¹¶ä¸”æœ‰æ•ˆï¼Œå¦‚æœæ˜¯å­˜åœ¨ä¸”æœ‰æ•ˆï¼Œåˆ™é€šè¿‡éªŒè¯ <code>await next()</code> ç»§ç»­æ‰§è¡Œåç»­çš„æ¥å£é€»è¾‘ã€‚å¦åˆ™åˆ¤æ–­æ˜¯å¤±æ•ˆè¿˜æ˜¯ä¸å­˜åœ¨è¯¥ <code>token</code>ã€‚</p>
<p>ä¸­é—´ä»¶å®Œæˆåï¼Œæˆ‘ä»¬åœ¨è·¯ç”±ä¸­<code>router.js</code> å»ä½¿ç”¨å®ƒ</p>
<pre><code class="js">&#39;use strict&#39;;

/**
 * @param &#123;Egg.Application&#125; app - egg application
 */
module.exports = app =&gt; &#123;
  const &#123; router, controller, middleware &#125; = app;
  const _jwt = middleware.jwtErr(app.config.jwt.secret); // ä¼ å…¥åŠ å¯†å­—ç¬¦ä¸²
  router.post(&#39;/api/user/register&#39;, controller.user.register);
  router.post(&#39;/api/user/login&#39;, controller.user.login);
  router.get(&#39;/api/user/test&#39;, _jwt, controller.user.test); // æ”¾å…¥ç¬¬äºŒä¸ªå‚æ•°ï¼Œä½œä¸ºä¸­é—´ä»¶è¿‡æ»¤é¡¹
&#125;;
</code></pre>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><em></em><a class="button is-default" href="/2022/08/03/82-egg-mysql/" title="82ã€egg-mysqlçš„å¢åˆ æ”¹æŸ¥"><span class="has-text-weight-semibold">ä¸‹ä¸€é¡µ: 82ã€egg-mysqlçš„å¢åˆ æ”¹æŸ¥</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/Jude"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- çŸ¥ä¹--><!-- é¢†è‹±--><!-- è„¸ä¹¦--></section><p><span>Copyright Â©</span><span> Jude 2022</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>