<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>websocketå®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„é€šä¿¡</title><meta name="description" content="ğŸ¯ ğŸ¯ ğŸ¯ ğŸ¯ ğŸ¯"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="WebSocket æ˜¯ HTML5 å¼€å§‹æä¾›çš„ä¸€ç§åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šè®¯çš„åè®®ã€‚ä¼ ç»Ÿçš„httpåè®®ï¼Œé€šä¿¡åªèƒ½ç”±å®¢æˆ·ç«¯å‘èµ·ã€‚websocketå®ç°äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åŒå‘å¹³ç­‰å¯¹è¯ï¼Œwebsocketæœ€å¤§çš„ç‰¹ç‚¹ï¼šæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨å‘ç”¨æˆ·æ¨é€ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘æœåŠ¡ç«¯å‘é€ä¿¡æ¯ã€‚


ä¸€ã€websocketç‰¹ç‚¹ï¼š
1ã€å»ºç«‹åœ¨ TCP åè®®ä¹‹ä¸Šï¼ŒæœåŠ¡å™¨ç«¯çš„å®ç°æ¯”è¾ƒå®¹æ˜“ã€‚2ã€ä¸ HTTP åè®®æœ‰ç€è‰¯å¥½çš„å…¼å®¹æ€§ï¼Œé»˜è®¤ç«¯å£ä¹Ÿæ˜¯80å’Œ443ã€‚å¹¶ä¸”æ¡æ‰‹é˜¶æ®µé‡‡ç”¨ HTTP åè®®ï¼Œå› æ­¤æ¡æ‰‹æ—¶ä¸å®¹æ˜“å±è”½ï¼Œèƒ½é€šè¿‡å„ç§ HTTP ä»£ç†æœåŠ¡å™¨ã€‚3ã€æ•°æ®æ ¼å¼æ¯”è¾ƒè½»é‡ï¼Œæ€§èƒ½å¼€é”€å°ï¼Œé€šä¿¡é«˜æ•ˆã€‚4ã€å¯ä»¥å‘é€æ–‡æœ¬ï¼Œä¹Ÿå¯ä»¥å‘é€äºŒè¿›åˆ¶æ•°æ®ã€‚5ã€æ²¡æœ‰åŒæºé™åˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä¸ä»»æ„æœåŠ¡å™¨é€šä¿¡ã€‚6ã€å…¨åŒå·¥(é€šä¿¡å…è®¸æ•°æ®åœ¨ä¸¤ä¸ªæ–¹å‘ä¸ŠåŒæ—¶ä¼ è¾“ï¼Œå®ƒåœ¨èƒ½åŠ›ä¸Š.."><meta name="generator" content="Hexo 6.0.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Jude's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">websocketå®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„é€šä¿¡</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">ç‚¹å‡»è¿”å›é¡¶éƒ¨</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">é¦–é¡µ</a></h3><h3 class="is-inline-block"><a href="/about">å…³äº</a></h3><h3 class="is-inline-block"><a href="/archives">å½’æ¡£</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">é¦–é¡µ</a></h3><h3 class="is-inline-block"><a href="/about">å…³äº</a></h3><h3 class="is-inline-block"><a href="/archives">å½’æ¡£</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81websocket%E7%89%B9%E7%82%B9%EF%BC%9A"><span class="toc-text">ä¸€ã€websocketç‰¹ç‚¹ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6"><span class="toc-text">äºŒã€å¿ƒè·³æœºåˆ¶</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/websocket"><i class="tag post-item-tag">websocket</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">websocketå®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„é€šä¿¡</h1><time class="has-text-grey" datetime="2022-01-03T12:00:00.000Z">2022-01-03</time><article class="mt-2 post-content"><p>WebSocket æ˜¯ HTML5 å¼€å§‹æä¾›çš„ä¸€ç§åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šè®¯çš„åè®®ã€‚ä¼ ç»Ÿçš„httpåè®®ï¼Œé€šä¿¡åªèƒ½ç”±å®¢æˆ·ç«¯å‘èµ·ã€‚websocketå®ç°äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åŒå‘å¹³ç­‰å¯¹è¯ï¼Œwebsocketæœ€å¤§çš„ç‰¹ç‚¹ï¼šæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨å‘ç”¨æˆ·æ¨é€ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘æœåŠ¡ç«¯å‘é€ä¿¡æ¯ã€‚</p>
<span id="more"></span>

<h2 id="ä¸€ã€websocketç‰¹ç‚¹ï¼š"><a href="#ä¸€ã€websocketç‰¹ç‚¹ï¼š" class="headerlink" title="ä¸€ã€websocketç‰¹ç‚¹ï¼š"></a>ä¸€ã€websocketç‰¹ç‚¹ï¼š</h2><blockquote>
<p>1ã€å»ºç«‹åœ¨ TCP åè®®ä¹‹ä¸Šï¼ŒæœåŠ¡å™¨ç«¯çš„å®ç°æ¯”è¾ƒå®¹æ˜“ã€‚<br>2ã€ä¸ HTTP åè®®æœ‰ç€è‰¯å¥½çš„å…¼å®¹æ€§ï¼Œé»˜è®¤ç«¯å£ä¹Ÿæ˜¯80å’Œ443ã€‚å¹¶ä¸”æ¡æ‰‹é˜¶æ®µé‡‡ç”¨ HTTP åè®®ï¼Œå› æ­¤æ¡æ‰‹æ—¶ä¸å®¹æ˜“å±è”½ï¼Œèƒ½é€šè¿‡å„ç§ HTTP ä»£ç†æœåŠ¡å™¨ã€‚<br>3ã€æ•°æ®æ ¼å¼æ¯”è¾ƒè½»é‡ï¼Œæ€§èƒ½å¼€é”€å°ï¼Œé€šä¿¡é«˜æ•ˆã€‚<br>4ã€å¯ä»¥å‘é€æ–‡æœ¬ï¼Œä¹Ÿå¯ä»¥å‘é€äºŒè¿›åˆ¶æ•°æ®ã€‚<br>5ã€æ²¡æœ‰åŒæºé™åˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä¸ä»»æ„æœåŠ¡å™¨é€šä¿¡ã€‚<br>6ã€å…¨åŒå·¥(é€šä¿¡å…è®¸æ•°æ®åœ¨ä¸¤ä¸ªæ–¹å‘ä¸ŠåŒæ—¶ä¼ è¾“ï¼Œå®ƒåœ¨èƒ½åŠ›ä¸Šç›¸å½“äºä¸¤ä¸ªå•å·¥é€šä¿¡æ–¹å¼çš„ç»“åˆ,ä¾‹å¦‚æŒ‡ Aâ†’B çš„åŒæ—¶ Bâ†’A ï¼Œæ˜¯ç¬æ—¶åŒæ­¥çš„)<br>7ã€åè®®æ ‡è¯†ç¬¦æ˜¯wsï¼ˆå¦‚æœåŠ å¯†ï¼Œåˆ™ä¸ºwssï¼‰ï¼ŒæœåŠ¡å™¨ç½‘å€å°±æ˜¯ URLã€‚</p>
</blockquote>
<p>åˆå§‹åŒ–websocket<br>1ã€åˆ›å»ºwebsocketå®ä¾‹ï¼Œå‚æ•°ä¸ºurl<br>2ã€è¿æ¥ websocket.onopen<br>3ã€serverå“åº”æ•°æ®è§¦å‘ websocket.onmessage<br>4ã€å…³é—­websocketï¼Œwebsocket.onclose</p>
<pre><code class="js">// æ„é€ å‡½æ•° å‚æ•°ä¸ºurl
const wsurl = &quot;ws://localhost:8080&quot;;
var ws = new Websocket(wsurl);

// è¿æ¥çŠ¶æ€readState 1  å‡†å¤‡å¥½å‘é€å’Œæ¥å—æ•°æ®äº†
ws.onopen = function()&#123;
  ws.send(&#39;hello server! websocket is open now!&#39;)
&#125;

// é€šè¿‡å®¢æˆ·ç«¯çš„äº‹ä»¶   å‘é€ä¿¡æ¯ç»™æœåŠ¡ç«¯
ws.send(&#39;hello websocket&#39;);

// å‘ç”Ÿé”™è¯¯
ws.onerror = function(event)&#123;
  console.log(&quot;websocket error observed&quot;,event)
&#125;

// readState CLOSED  å…³é—­websocket
ws.onclose = function(event)&#123;
  let status_code = event.status;
  let msg = event.msg;
  console.log(&quot;websocket is closed now&quot;)
&#125;

// å“åº”æ•°æ®çš„æ¥æ”¶
ws.onmessage = function(event)&#123;
  let data = event.data;
&#125;
</code></pre>
<ul>
<li>è·¯ç”±æ”¹å˜ï¼Œéœ€è¦æ–­å¼€websocketè¿æ¥ï¼ŒèŠ‚çœæœåŠ¡å™¨å¼€æ”¯ã€‚</li>
</ul>
<h2 id="äºŒã€å¿ƒè·³æœºåˆ¶"><a href="#äºŒã€å¿ƒè·³æœºåˆ¶" class="headerlink" title="äºŒã€å¿ƒè·³æœºåˆ¶"></a>äºŒã€å¿ƒè·³æœºåˆ¶</h2><blockquote>
<p>websocketåœ¨è¿æ¥å…³é—­çš„æƒ…å†µä¸‹è§¦å‘oncloseäº‹ä»¶ï¼Œè¿æ¥å¼‚å¸¸è§¦å‘onerroräº‹ä»¶ã€‚ç½‘ç»œçŠ¶æ€ä¸å¥½çš„æƒ…å†µï¼Œoncloseäº‹ä»¶çš„è§¦å‘çµæ•åº¦ä¸é«˜ï¼Œå¯èƒ½ä¼šé€ æˆæ–­ç½‘å¾ˆä¹…è§¦å‘oncloseäº‹ä»¶ï¼Œå®¢æˆ·ç«¯åˆå‡ºç°é‡æ–°è¿æ¥ï¼Œå®¢æˆ·ç«¯å®æ—¶ç•Œé¢ä¸å‹å¥½ã€‚</p>
</blockquote>
<p>ä¸ºäº†è§£å†³ä¸Šé¢çš„æƒ…å†µï¼Œä½¿ç”¨å¿ƒè·³é‡è¿æœºåˆ¶ï¼Œå®¢æˆ·ç«¯åœ¨websocketè¿æ¥æˆåŠŸåï¼Œæ‰§è¡Œå¿ƒè·³å‡½æ•°ï¼Œé¦–å…ˆå‘æœåŠ¡å™¨å‘é€â€™pingâ€˜ä¿¡æ¯ï¼ŒæœåŠ¡å™¨æ”¶åˆ°ä¿¡æ¯ä¼šè¿”å›â€™pongâ€™ä¿¡æ¯ã€‚ä¸€å®šæ—¶é—´å†…ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„ä¿¡æ¯ï¼Œåˆ™è¡¨ç¤ºè¿æ¥æ­£å¸¸ï¼Œé‡ç½®å¿ƒè·³å‡½æ•°ï¼›å®¢æˆ·ç«¯åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å¿ƒè·³å‡½æ•°ï¼Œè¡¨æ˜æ²¡æœ‰è¿æ¥æˆåŠŸï¼Œå®¢æˆ·ç«¯å…³é—­websocket,å†æ‰§è¡Œé‡è¿æ“ä½œã€‚</p>
<p>è§£å†³æ–¹å¼ï¼š</p>
<details>
<summary>ç‚¹æˆ‘å±•ç¤ºä»£ç </summary>

<pre><code class="js">import &#123; mapActions, mapState &#125; from &#39;vuex&#39;;
export default &#123;
    name: &#39;Websocket&#39;,
    data() &#123;
        return &#123;
            // æ˜¯å¦æ­£åœ¨é‡è¿
            lockReconnect: false,
            socket: null,
            reconnectTimeout: null,
            timeout: 10 * 1000,
            timer: null,
            serverTimer: null
        &#125;;
    &#125;,
    computed: &#123;
        ...mapState([&#39;userInfo&#39;]),
        wsuri() &#123;
            return `$&#123;process.env.VUE_APP_WEBSOCKET_URI&#125;$&#123;this.userInfo.tenantId&#125;;$&#123;this.userInfo.userId&#125;`;
        &#125;
    &#125;,
    async mounted() &#123;
        await this.getUserInfo();
        this.initWebSocket();
    &#125;,
    destroyed() &#123;
        this.socket.close();
    &#125;,
    methods: &#123;
        ...mapActions([&#39;getUserInfo&#39;]),
        start(ws) &#123;
            this.reset();
            this.timer = setTimeout(() =&gt; &#123;
                // console.log(&#39;å‘é€å¿ƒè·³,åç«¯æ”¶åˆ°åï¼Œè¿”å›ä¸€ä¸ªå¿ƒè·³æ¶ˆæ¯&#39;)
                // onmessageæ‹¿åˆ°è¿”å›çš„å¿ƒè·³å°±è¯´æ˜è¿æ¥æ­£å¸¸
                ws.send(&#39;ping&#39;);
                this.serverTimer = setTimeout(() =&gt; &#123;
                    // å¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´è¿˜æ²¡å“åº”(å“åº”åè§¦å‘é‡ç½®)ï¼Œè¯´æ˜åç«¯æ–­å¼€äº†
                    ws.close();
                &#125;, this.timeout);
            &#125;, this.timeout);
        &#125;,
        reset() &#123;
            this.serverTimer &amp;&amp; clearTimeout(this.serverTimer);
            this.timer &amp;&amp; clearTimeout(this.timer);
        &#125;,
        reconnect() &#123;
            console.log(&#39;å°è¯•é‡è¿&#39;);
            if (this.lockReconnect) &#123;
                return;
            &#125;
            this.lockReconnect = true;
            this.reconnectTimeout &amp;&amp; clearTimeout(this.reconnectTimeout);
            this.reconnectTimeout = setTimeout(() =&gt; &#123;
                this.initWebSocket();
                this.lockReconnect = false;
            &#125;, 4 * 1000);
        &#125;,
        // åˆå§‹åŒ–websocket
        initWebSocket() &#123;
            try &#123;
                if (&#39;WebSocket&#39; in window) &#123;
                    this.socket = new WebSocket(this.wsuri);
                &#125; else &#123;
                    console.log(&#39;æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒwebsocket&#39;);
                &#125;
                this.socket.onopen = this.websocketOnOpen;
                this.socket.onerror = this.websocketOnError;
                this.socket.onmessage = this.websocketOnMessage;
                this.socket.onclose = this.websocketClose;
            &#125; catch (e) &#123;
                this.reconnect();
            &#125;
        &#125;,
        websocketOnOpen() &#123;
            console.log(&#39;WebSocketè¿æ¥æˆåŠŸ&#39;, this.socket.readyState);
            this.start(this.socket);
            this.websocketSend();
        &#125;,
        websocketOnError(e) &#123;
            console.log(&#39;WebSocketè¿æ¥å‘ç”Ÿé”™è¯¯&#39;, e);
            this.reconnect();
        &#125;,
        websocketOnMessage(e) &#123;
            if (e.data === &#39;pong&#39;) &#123;
                // æ¶ˆæ¯è·å–æˆåŠŸï¼Œé‡ç½®å¿ƒè·³
                this.start(this.socket);
            &#125;
        &#125;,
        websocketClose(e) &#123;
            console.log(&#39;connection closed (&#39; + e.code + &#39;)&#39;);
            this.reconnect();
        &#125;,
        websocketSend() &#123;
            this.socket.send(&#39;ping&#39;);
        &#125;
    &#125;
&#125;;
</code></pre>
</details>



</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2022/01/13/count-to/" title="CountTo:æ•°å­—åŠ¨æ€æ»šåŠ¨"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">ä¸Šä¸€é¡µ: CountTo:æ•°å­—åŠ¨æ€æ»šåŠ¨</span></a><a class="button is-default" href="/2022/01/01/hook/" title="ç”¨hookå¤„ç†ç»„ä»¶å†…å®šæ—¶å™¨"><span class="has-text-weight-semibold">ä¸‹ä¸€é¡µ: ç”¨hookå¤„ç†ç»„ä»¶å†…å®šæ—¶å™¨</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/Jude"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- çŸ¥ä¹--><!-- é¢†è‹±--><!-- è„¸ä¹¦--></section><p><span>Copyright Â©</span><span> Jude 2022</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>