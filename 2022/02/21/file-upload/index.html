<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>å¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼ </title><meta name="description" content="ğŸ¯ ğŸ¯ ğŸ¯ ğŸ¯ ğŸ¯"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="å…³äºå¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼ çš„é—®é¢˜,è§£å†³æ–¹æ¡ˆæ˜¯Blob.prototype.sliceæ–¹æ³•ï¼Œå’Œæ•°ç»„çš„sliceæ–¹æ³•ç±»ä¼¼ï¼Œä½¿ç”¨sliceæ–¹æ³•å¯ä»¥è¿”å›æºæ–‡ä»¶çš„åˆ‡ç‰‡ã€‚æŒ‰ç…§è¦æ±‚å°†æºæ–‡ä»¶åˆ‡ä½nä¸ªåˆ‡ç‰‡ï¼Œå°†å¤šä¸ªåˆ‡ç‰‡åŒæ—¶ä¸Šä¼ ï¼Œæºæ–‡ä»¶ç”±ä¸€ä¸ªå¤§æ–‡ä»¶è½¬æ¢æˆnä¸ªå°åˆ‡ç‰‡åŒæ—¶ä¸Šä¼ ï¼Œå¯ä»¥å¤§å¤§å‡å°‘ä¸Šä¼ æ—¶é—´ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä¸Šä¼ åˆ°æœåŠ¡ç«¯çš„åˆ‡ç‰‡å¯èƒ½ä½ç½®ä¼šå‘ç”Ÿæ”¹å˜ï¼Œéœ€è¦å°†åˆ‡ç‰‡çš„ä½ç½®è®°å½•ä¸‹æ¥ã€‚


ä¸€ã€æœåŠ¡ç«¯ï¼ˆNode.jsï¼‰æœåŠ¡ç«¯éœ€è¦åšçš„æ˜¯ï¼šæ¥å—nä¸ªåˆ‡ç‰‡ï¼Œå¹¶å°†è¿™äº›åˆ‡ç‰‡åœ¨ä¸Šä¼ ååˆå¹¶ã€‚
éœ€è¦æ³¨æ„çš„æ˜¯ï¼š
1ã€åˆå¹¶åˆ‡ç‰‡çš„æ—¶é—´: å³nä¸ªåˆ‡ç‰‡ä»€ä¹ˆæ—¶å€™ä¸Šä¼ å®Œæˆ

å‰ç«¯ä¸Šä¼ çš„åˆ‡ç‰‡ä¸­å¸¦æœ‰åˆ‡ç‰‡çš„ä¸ªæ•°ï¼ŒæœåŠ¡ç«¯æ¥å—åˆ°åˆ‡ç‰‡çš„æ€»æ•°åè‡ªåŠ¨åˆå¹¶2ã€æ€ä¹ˆåˆå¹¶åˆ‡ç‰‡ä½¿ç”¨node.jsçš„è¯»å†™æµ(readStream/writeStream)ï¼Œå°†æ‰€æœ‰åˆ‡ç‰‡çš„æµä¼ è¾“åˆ°æœ€ç»ˆæ–‡ä»¶çš„æµé‡Œã€‚

æœåŠ¡ç«¯ï¼š

se.."><meta name="generator" content="Hexo 5.4.1"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Jude's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">å¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼ </p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">ç‚¹å‡»è¿”å›é¡¶éƒ¨</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">é¦–é¡µ</a></h3><h3 class="is-inline-block"><a href="/about">å…³äº</a></h3><h3 class="is-inline-block"><a href="/archives">å½’æ¡£</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">é¦–é¡µ</a></h3><h3 class="is-inline-block"><a href="/about">å…³äº</a></h3><h3 class="is-inline-block"><a href="/archives">å½’æ¡£</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%88Node-js%EF%BC%89"><span class="toc-text">ä¸€ã€æœåŠ¡ç«¯ï¼ˆNode.jsï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">äºŒã€å®¢æˆ·ç«¯</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/vue"><i class="tag post-item-tag">vue</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">å¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼ </h1><time class="has-text-grey" datetime="2022-02-20T16:00:00.000Z">2022-02-21</time><article class="mt-2 post-content"><p>å…³äºå¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼ çš„é—®é¢˜,è§£å†³æ–¹æ¡ˆæ˜¯Blob.prototype.sliceæ–¹æ³•ï¼Œå’Œæ•°ç»„çš„sliceæ–¹æ³•ç±»ä¼¼ï¼Œä½¿ç”¨sliceæ–¹æ³•å¯ä»¥è¿”å›æºæ–‡ä»¶çš„åˆ‡ç‰‡ã€‚æŒ‰ç…§è¦æ±‚å°†æºæ–‡ä»¶åˆ‡ä½nä¸ªåˆ‡ç‰‡ï¼Œå°†å¤šä¸ªåˆ‡ç‰‡åŒæ—¶ä¸Šä¼ ï¼Œæºæ–‡ä»¶ç”±ä¸€ä¸ªå¤§æ–‡ä»¶è½¬æ¢æˆnä¸ªå°åˆ‡ç‰‡åŒæ—¶ä¸Šä¼ ï¼Œå¯ä»¥å¤§å¤§å‡å°‘ä¸Šä¼ æ—¶é—´ã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ä¸Šä¼ åˆ°æœåŠ¡ç«¯çš„åˆ‡ç‰‡å¯èƒ½ä½ç½®ä¼šå‘ç”Ÿæ”¹å˜ï¼Œéœ€è¦å°†åˆ‡ç‰‡çš„ä½ç½®è®°å½•ä¸‹æ¥ã€‚</p>
<span id="more"></span>

<h2 id="ä¸€ã€æœåŠ¡ç«¯ï¼ˆNode-jsï¼‰"><a href="#ä¸€ã€æœåŠ¡ç«¯ï¼ˆNode-jsï¼‰" class="headerlink" title="ä¸€ã€æœåŠ¡ç«¯ï¼ˆNode.jsï¼‰"></a>ä¸€ã€æœåŠ¡ç«¯ï¼ˆNode.jsï¼‰</h2><p>æœåŠ¡ç«¯éœ€è¦åšçš„æ˜¯ï¼šæ¥å—nä¸ªåˆ‡ç‰‡ï¼Œå¹¶å°†è¿™äº›åˆ‡ç‰‡åœ¨ä¸Šä¼ ååˆå¹¶ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<p>1ã€åˆå¹¶åˆ‡ç‰‡çš„æ—¶é—´: å³nä¸ªåˆ‡ç‰‡ä»€ä¹ˆæ—¶å€™ä¸Šä¼ å®Œæˆ</p>
<blockquote>
<p>å‰ç«¯ä¸Šä¼ çš„åˆ‡ç‰‡ä¸­å¸¦æœ‰åˆ‡ç‰‡çš„ä¸ªæ•°ï¼ŒæœåŠ¡ç«¯æ¥å—åˆ°åˆ‡ç‰‡çš„æ€»æ•°åè‡ªåŠ¨åˆå¹¶<br>2ã€æ€ä¹ˆåˆå¹¶åˆ‡ç‰‡<br>ä½¿ç”¨node.jsçš„è¯»å†™æµ(readStream/writeStream)ï¼Œå°†æ‰€æœ‰åˆ‡ç‰‡çš„æµä¼ è¾“åˆ°æœ€ç»ˆæ–‡ä»¶çš„æµé‡Œã€‚</p>
</blockquote>
<p>æœåŠ¡ç«¯ï¼š</p>
<blockquote>
<p>server<br>-index.js<br>-controller.js</p>
</blockquote>
<details>
<summary>ç‚¹æˆ‘å±•ç¤ºä»£ç </summary>

<pre><code class="js">// index.js
const Controller = require(&quot;./controller&quot;);
const http = require(&quot;http&quot;);
const server = http.createServer();

const controller = new Controller();

server.on(&quot;request&quot;, async (req, res) =&gt; &#123;
  res.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);
  // è§£å†³è·¨åŸŸ   
  res.setHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;*&quot;);
  if (req.method === &quot;OPTIONS&quot;) &#123;
    res.status = 200;
    res.end();
    return;
  &#125;
//   éªŒè¯ä¸Šä¼ æ–‡ä»¶æ˜¯å¦å·²ä¸Šä¼ 
  if (req.url === &quot;/verify&quot;) &#123;
    await controller.handleVerifyUpload(req, res);
    return;
  &#125;
    // åˆå¹¶åˆ‡ç‰‡
  if (req.url === &quot;/merge&quot;) &#123;
    await controller.handleMerge(req, res);
    return;
  &#125;
  if (req.url === &quot;/&quot;) &#123;
    await controller.handleFormData(req, res);
  &#125;
&#125;);

server.listen(3001, () =&gt; console.log(&quot;æ­£åœ¨ç›‘å¬ 3001 ç«¯å£&quot;));
</code></pre>
<pre><code class="js">// controller.js
// å¤„ç†å‰ç«¯ä¼ æ¥çš„FormData
const multiparty = require(&quot;multiparty&quot;);
const path = require(&quot;path&quot;);
const fse = require(&quot;fs-extra&quot;);

const extractExt = filename =&gt;
  filename.slice(filename.lastIndexOf(&quot;.&quot;), filename.length); // æå–åç¼€å
const UPLOAD_DIR = path.resolve(__dirname, &quot;..&quot;, &quot;target&quot;); // å¤§æ–‡ä»¶å­˜å‚¨ç›®å½•

const pipeStream = (path, writeStream) =&gt;
  new Promise(resolve =&gt; &#123;
    //   åˆ›å»ºå¯è¯»æµ
    const readStream = fse.createReadStream(path);
    readStream.on(&quot;end&quot;, () =&gt; &#123;
      fse.unlinkSync(path);
      resolve();
    &#125;);
    readStream.pipe(writeStream);
  &#125;);

// åˆå¹¶åˆ‡ç‰‡
const mergeFileChunk = async (filePath, fileHash, size) =&gt; &#123;
  const chunkDir = path.resolve(UPLOAD_DIR, fileHash);
  const chunkPaths = await fse.readdir(chunkDir);
  // æ ¹æ®åˆ‡ç‰‡ä¸‹æ ‡è¿›è¡Œæ’åº
  // å¦åˆ™ç›´æ¥è¯»å–ç›®å½•çš„è·å¾—çš„é¡ºåºå¯èƒ½ä¼šé”™ä¹±
  chunkPaths.sort((a, b) =&gt; a.split(&quot;-&quot;)[1] - b.split(&quot;-&quot;)[1]);
  await Promise.all(
    chunkPaths.map((chunkPath, index) =&gt;
      pipeStream(
        path.resolve(chunkDir, chunkPath),
        // æŒ‡å®šä½ç½®åˆ›å»ºå¯å†™æµ
        fse.createWriteStream(filePath, &#123;
          start: index * size,
          end: (index + 1) * size
        &#125;)
      )
    )
  );
  fse.rmdirSync(chunkDir); // åˆå¹¶ååˆ é™¤ä¿å­˜åˆ‡ç‰‡çš„ç›®å½•
&#125;;

const resolvePost = req =&gt;
  new Promise(resolve =&gt; &#123;
    let chunk = &quot;&quot;;
    req.on(&quot;data&quot;, data =&gt; &#123;
      chunk += data;
    &#125;);
    req.on(&quot;end&quot;, () =&gt; &#123;
      resolve(JSON.parse(chunk));
    &#125;);
  &#125;);

// è¿”å›å·²ç»ä¸Šä¼ åˆ‡ç‰‡å
const createUploadedList = async fileHash =&gt;
  fse.existsSync(path.resolve(UPLOAD_DIR, fileHash))
    ? await fse.readdir(path.resolve(UPLOAD_DIR, fileHash))
    : [];

module.exports = class &#123;
  // åˆå¹¶åˆ‡ç‰‡
  async handleMerge(req, res) &#123;
    const data = await resolvePost(req);
    const &#123; fileHash, filename, size &#125; = data;
    const ext = extractExt(filename);
    const filePath = path.resolve(UPLOAD_DIR, `$&#123;fileHash&#125;$&#123;ext&#125;`);
    await mergeFileChunk(filePath, fileHash, size);
    res.end(
      JSON.stringify(&#123;
        code: 0,
        message: &quot;file merged success&quot;
      &#125;)
    );
  &#125;
  // å¤„ç†åˆ‡ç‰‡
  async handleFormData(req, res) &#123;
    const multipart = new multiparty.Form();
    //ä¸‹é¢multipart.parseçš„å›è°ƒä¸­ fields å‚æ•°ä¿å­˜äº†FormDataä¸­çš„æ–‡ä»¶
    multipart.parse(req, async (err, fields, files) =&gt; &#123;
      if (err) &#123;
        console.error(err);
        res.status = 500;
        res.end(&quot;process file chunk failed&quot;);
        return;
      &#125;
      const [chunk] = files.chunk;
      const [hash] = fields.hash;
      const [fileHash] = fields.fileHash;
      const [filename] = fields.filename;
      const filePath = path.resolve(
        UPLOAD_DIR,
        `$&#123;fileHash&#125;$&#123;extractExt(filename)&#125;`
      );
      const chunkDir = path.resolve(UPLOAD_DIR, fileHash);

      // æ–‡ä»¶å­˜åœ¨ç›´æ¥è¿”å›
      if (fse.existsSync(filePath)) &#123;
        res.end(&quot;file exist&quot;);
        return;
      &#125;

      // åˆ‡ç‰‡ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºåˆ‡ç‰‡ç›®å½•
      if (!fse.existsSync(chunkDir)) &#123;
        await fse.mkdirs(chunkDir);
      &#125;
      // fs-extra ä¸“ç”¨æ–¹æ³•ï¼Œç±»ä¼¼ fs.rename å¹¶ä¸”è·¨å¹³å°
      // fs-extra çš„ rename æ–¹æ³• windows å¹³å°ä¼šæœ‰æƒé™é—®é¢˜
      // https://github.com/meteor/meteor/issues/7852#issuecomment-255767835
      await fse.move(chunk.path, path.resolve(chunkDir, hash));
      res.end(&quot;received file chunk&quot;);
    &#125;);
  &#125;
  // éªŒè¯æ˜¯å¦å·²ä¸Šä¼ /å·²ä¸Šä¼ åˆ‡ç‰‡ä¸‹æ ‡
  async handleVerifyUpload(req, res) &#123;
    const data = await resolvePost(req);
    const &#123; fileHash, filename &#125; = data;
    const ext = extractExt(filename);
    const filePath = path.resolve(UPLOAD_DIR, `$&#123;fileHash&#125;$&#123;ext&#125;`);
    if (fse.existsSync(filePath)) &#123;
      res.end(
        JSON.stringify(&#123;
          shouldUpload: false
        &#125;)
      );
    &#125; else &#123;
      res.end(
        JSON.stringify(&#123;
          shouldUpload: true,
          uploadedList: await createUploadedList(fileHash)
        &#125;)
      );
    &#125;
  &#125;
&#125;;
</code></pre>
</details>


<h2 id="äºŒã€å®¢æˆ·ç«¯"><a href="#äºŒã€å®¢æˆ·ç«¯" class="headerlink" title="äºŒã€å®¢æˆ·ç«¯"></a>äºŒã€å®¢æˆ·ç«¯</h2><p>å‰ç«¯ä½¿ç”¨Vue+elementUIå±•ç¤ºç•Œé¢ï¼Œå½“ç‚¹å‡»ä¸Šä¼ æŒ‰é’®æ—¶ï¼Œsliceæ–¹æ³•å°†æºæ–‡ä»¶åšåˆ‡ç‰‡å¤„ç†ï¼Œå°†åˆ‡ç‰‡æ”¾å…¥æ•°ç»„ä¸­è¿”å›ï¼Œä½¿ç”¨ hash+index ç»™æ¯ä¸ªåˆ‡ç‰‡åšæ ‡è¯†ï¼Œç”¨äºä¸Šä¼ å®Œæˆååˆå¹¶åˆ‡ç‰‡ã€‚<br>è°ƒç”¨uploadChunksä¸Šä¼ æ‰€æœ‰çš„åˆ‡ç‰‡ï¼Œå°†åˆ‡ç‰‡ã€åˆ‡ç‰‡hashã€åˆ‡ç‰‡åfilenameæ”¾å…¥FormDataä¸­ï¼Œä½¿ç”¨promise.allå¹¶å‘ä¸Šä¼ æ‰€æœ‰åˆ‡ç‰‡ã€‚</p>
<p>æ–­ç‚¹ç»­ä¼ åŸç†åœ¨äºå‰åç«¯éœ€è¦è®°ä½å·²ç»ä¸Šä¼ çš„åˆ‡ç‰‡ï¼Œç»§ç»­ä¸Šä¼ çš„æ—¶å€™å°±å¯ä»¥è·³è¿‡ä¹‹å‰å·²ç»ä¸Šä¼ çš„éƒ¨åˆ†ã€‚</p>
<p>å®ç°çš„æ–¹æ¡ˆï¼š</p>
<blockquote>
<p>æœåŠ¡ç«¯ä¿å­˜å·²ç»ä¸Šä¼ çš„åˆ‡ç‰‡hashï¼Œå‰ç«¯æ¯æ¬¡ä¸Šä¼ å‰éƒ½å‘æœåŠ¡ç«¯è·å–å·²ç»ä¸Šä¼ çš„åˆ‡ç‰‡ã€‚</p>
</blockquote>
<p>è¿™é‡Œä¹Ÿå¯ä»¥åœ¨å‰ç«¯ä½¿ç”¨localStorageè®°å½•å·²ç»ä¸Šä¼ çš„åˆ‡ç‰‡çš„hashï¼Œä½†æ˜¯å­˜åœ¨é—®é¢˜ï¼Œå°±æ˜¯æ¢ä¸€ä¸ªæµè§ˆå™¨å°±å¤±å»å·²ç»ä¸Šä¼ çš„åˆ‡ç‰‡çš„hashäº†ã€‚</p>
<p>å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯éƒ½éœ€è¦ç”Ÿæˆæ–‡ä»¶å’Œåˆ‡ç‰‡çš„hashï¼Œæ ¹æ®æ–‡ä»¶å†…å®¹ç”Ÿæˆhashã€‚ä½¿ç”¨spark-md5æ ¹æ®æ–‡ä»¶å†…å®¹è®¡ç®—å‡ºæ–‡ä»¶çš„hashå€¼ã€‚</p>
<p>å½“æ–‡ä»¶æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œè¯»å–æ–‡ä»¶å†…å®¹è®¡ç®—hashæ˜¯éå¸¸è€—æ—¶çš„ï¼Œä¼šå¼•èµ·UIé˜»å¡ï¼Œå¯¼è‡´é¡µé¢å‡æ­»ï¼Œè§£å†³æ–¹å¼æ˜¯ä½¿ç”¨web-workeråœ¨workerçº¿ç¨‹è®¡ç®—hashã€‚</p>
<p>å®ä¾‹åŒ–web-workerï¼Œå‚æ•°æ˜¯ä¸€ä¸ªjsæ–‡ä»¶è·¯å¾„ä¸èƒ½è·¨åŸŸï¼Œéœ€è¦å•ç‹¬åˆ›å»ºä¸€ä¸ªhash.jsæ–‡ä»¶æ”¾åœ¨publicä¸­ï¼Œåœ¨workerä¸­ä¸å…è®¸è®¿é—®domï¼Œä½¿ç”¨importScriptså‡½æ•°å¯¼å…¥å¤–éƒ¨è„šæœ¬spark-md5</p>
<pre><code class="js">// hash.js
self.importScripts(&quot;/spark-md5.min.js&quot;); // å¯¼å…¥è„šæœ¬

// ç”Ÿæˆæ–‡ä»¶ hash
self.onmessage = e =&gt; &#123;
  const &#123; fileChunkList &#125; = e.data;
  const spark = new self.SparkMD5.ArrayBuffer();
  let percentage = 0;
  let count = 0;
  const loadNext = index =&gt; &#123;
    const reader = new FileReader();
    reader.readAsArrayBuffer(fileChunkList[index].file);
    reader.onload = e =&gt; &#123;
      count++;
      spark.append(e.target.result);
      if (count === fileChunkList.length) &#123;
        self.postMessage(&#123;
          percentage: 100,
          hash: spark.end()
        &#125;);
        self.close();
      &#125; else &#123;
        percentage += 100 / fileChunkList.length;
        self.postMessage(&#123;
          percentage
        &#125;);
        loadNext(count);
      &#125;
    &#125;;
  &#125;;
  loadNext(0);
&#125;;
</code></pre>
<p>1ã€template</p>
<details>
<summary>ç‚¹æˆ‘å±•ç¤ºä»£ç </summary>

<pre><code class="html">    &lt;div&gt;
      &lt;input
        type=&quot;file&quot;
        :disabled=&quot;status !== Status.wait&quot;
        @change=&quot;handleFileChange&quot;
      /&gt;
      &lt;el-button @click=&quot;handleUpload&quot; :disabled=&quot;uploadDisabled&quot;
        &gt;ä¸Šä¼ &lt;/el-button
      &gt;
      &lt;el-button @click=&quot;handleResume&quot; v-if=&quot;status === Status.pause&quot;
        &gt;æ¢å¤&lt;/el-button
      &gt;
      &lt;el-button
        v-else
        :disabled=&quot;status !== Status.uploading || !container.hash&quot;
        @click=&quot;handlePause&quot;
        &gt;æš‚åœ&lt;/el-button
      &gt;
    &lt;/div&gt;
    &lt;div&gt;
      &lt;!-- &lt;div&gt;è®¡ç®—æ–‡ä»¶ hash&lt;/div&gt;
      &lt;el-progress :percentage=&quot;hashPercentage&quot;&gt;&lt;/el-progress&gt; --&gt;
      &lt;div&gt;æ€»è¿›åº¦&lt;/div&gt;
      &lt;el-progress :percentage=&quot;fakeUploadPercentage&quot;&gt;&lt;/el-progress&gt;
    &lt;/div&gt;
    &lt;el-table :data=&quot;data&quot;&gt;
      &lt;el-table-column
        prop=&quot;hash&quot;
        label=&quot;åˆ‡ç‰‡hash&quot;
        align=&quot;center&quot;
      &gt;&lt;/el-table-column&gt;
      &lt;el-table-column label=&quot;å¤§å°(KB)&quot; align=&quot;center&quot; width=&quot;120&quot;&gt;
        &lt;template v-slot=&quot;&#123; row &#125;&quot;&gt;
          &#123;&#123; row.size | transformByte &#125;&#125;
        &lt;/template&gt;
      &lt;/el-table-column&gt;
      &lt;el-table-column label=&quot;è¿›åº¦&quot; align=&quot;center&quot;&gt;
        &lt;template v-slot=&quot;&#123; row &#125;&quot;&gt;
          &lt;el-progress
            :percentage=&quot;row.percentage&quot;
            color=&quot;#909399&quot;
          &gt;&lt;/el-progress&gt;
        &lt;/template&gt;
      &lt;/el-table-column&gt;
    &lt;/el-table&gt;
</code></pre>
</details>


<p>2ã€jséƒ¨åˆ†ï¼šè®¾ç½®åˆ‡ç‰‡å¤§å° è€ƒè™‘åˆ°é€šç”¨æ€§ï¼Œç®€å•å°è£…äº†XMLHttpRequest, å®é™…ä½¿ç”¨å¯ä»¥éšè—æ‰hashè¿›åº¦æ¡</p>
<details>
<summary>ç‚¹æˆ‘å±•ç¤ºä»£ç </summary>

<pre><code class="js">&lt;script&gt;
const SIZE = 100 * 1024 * 1024; // åˆ‡ç‰‡å¤§å°

const Status = &#123;
  wait: &quot;wait&quot;,
  pause: &quot;pause&quot;,
  uploading: &quot;uploading&quot;
&#125;;


export default &#123;
  name: &quot;app&quot;,
  filters: &#123;
    transformByte(val) &#123;
      return Number((val / 1024).toFixed(0));
    &#125;
  &#125;,
  data: () =&gt; (&#123;
    Status,
    container: &#123;
      file: null,
      hash: &quot;&quot;,
      worker: null
    &#125;,
    hashPercentage: 0,
    data: [],
    requestList: [],
    status: Status.wait,
    // å½“æš‚åœæ—¶ä¼šå–æ¶ˆ xhr å¯¼è‡´è¿›åº¦æ¡åé€€
    // ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªå‡çš„è¿›åº¦æ¡
    fakeUploadPercentage: 0
  &#125;),
  computed: &#123;
    uploadDisabled() &#123;
      return (
        !this.container.file ||
        [Status.pause, Status.uploading].includes(this.status)
      );
    &#125;,
    uploadPercentage() &#123;
      if (!this.container.file || !this.data.length) return 0;
      const loaded = this.data
        .map(item =&gt; item.size * item.percentage)
        .reduce((acc, cur) =&gt; acc + cur);
      return parseInt((loaded / this.container.file.size).toFixed(2));
    &#125;
  &#125;,
  watch: &#123;
    uploadPercentage(now) &#123;
      if (now &gt; this.fakeUploadPercentage) &#123;
        this.fakeUploadPercentage = now;
      &#125;
    &#125;
  &#125;,
  methods: &#123;
    // æš‚åœ
    handlePause() &#123;
      this.status = Status.pause;
      this.resetData();
    &#125;,
    resetData() &#123;
      this.requestList.forEach(xhr =&gt; xhr?.abort());
      this.requestList = [];
      if (this.container.worker) &#123;
        this.container.worker.onmessage = null;
      &#125;
    &#125;,
    async handleResume() &#123;
      this.status = Status.uploading;
      const &#123; uploadedList &#125; = await this.verifyUpload(
        this.container.file.name,
        this.container.hash
      );
      await this.uploadChunks(uploadedList);
    &#125;,
    // xhr
    request(&#123;
      url,
      method = &quot;post&quot;,
      data,
      headers = &#123;&#125;,
      onProgress = e =&gt; e,
      requestList
    &#125;) &#123;
      return new Promise(resolve =&gt; &#123;
        const xhr = new XMLHttpRequest();
        xhr.upload.onprogress = onProgress;
        xhr.open(method, url);
        Object.keys(headers).forEach(key =&gt;
          xhr.setRequestHeader(key, headers[key])
        );
        xhr.send(data);
        xhr.onload = e =&gt; &#123;
          // å°†è¯·æ±‚æˆåŠŸçš„ xhr ä»åˆ—è¡¨ä¸­åˆ é™¤
          if (requestList) &#123;
            const xhrIndex = requestList.findIndex(item =&gt; item === xhr);
            requestList.splice(xhrIndex, 1);
          &#125;
          resolve(&#123;
            data: e.target.response
          &#125;);
        &#125;;
        // æš´éœ²å½“å‰ xhr ç»™å¤–éƒ¨
        requestList?.push(xhr);
      &#125;);
    &#125;,
    // ç”Ÿæˆæ–‡ä»¶åˆ‡ç‰‡
    createFileChunk(file, size = SIZE) &#123;
      const fileChunkList = [];
      let cur = 0;
      while (cur &lt; file.size) &#123;
        fileChunkList.push(&#123; file: file.slice(cur, cur + size) &#125;);
        cur += size;
      &#125;
      return fileChunkList;
    &#125;,
    // ç”Ÿæˆæ–‡ä»¶ hashï¼ˆweb-workerï¼‰
    calculateHash(fileChunkList) &#123;
      return new Promise(resolve =&gt; &#123;
        this.container.worker = new Worker(&quot;/hash.js&quot;);
        this.container.worker.postMessage(&#123; fileChunkList &#125;);
        this.container.worker.onmessage = e =&gt; &#123;
          const &#123; percentage, hash &#125; = e.data;
          this.hashPercentage = percentage;
          if (hash) &#123;
            resolve(hash);
          &#125;
        &#125;;
      &#125;);
    &#125;,
    handleFileChange(e) &#123;
      const [file] = e.target.files;
      if (!file) return;
      this.resetData();
      Object.assign(this.$data, this.$options.data());
      this.container.file = file;
    &#125;,
    async handleUpload() &#123;
      if (!this.container.file) return;
      this.status = Status.uploading;
      const fileChunkList = this.createFileChunk(this.container.file);
      this.container.hash = await this.calculateHash(fileChunkList);

      const &#123; shouldUpload, uploadedList &#125; = await this.verifyUpload(
        this.container.file.name,
        this.container.hash
      );
      if (!shouldUpload) &#123;
        this.$message.success(&quot;ç§’ä¼ ï¼šä¸Šä¼ æˆåŠŸ&quot;);
        this.status = Status.wait;
        return;
      &#125;

      this.data = fileChunkList.map((&#123; file &#125;, index) =&gt; (&#123;
        fileHash: this.container.hash,
        index,
        hash: this.container.hash + &quot;-&quot; + index,
        chunk: file,
        size: file.size,
        percentage: uploadedList.includes(index) ? 100 : 0
      &#125;));

      await this.uploadChunks(uploadedList);
    &#125;,
    // ä¸Šä¼ åˆ‡ç‰‡ï¼ŒåŒæ—¶è¿‡æ»¤å·²ä¸Šä¼ çš„åˆ‡ç‰‡
    async uploadChunks(uploadedList = []) &#123;
      const requestList = this.data
        .filter((&#123; hash &#125;) =&gt; !uploadedList.includes(hash))
        .map((&#123; chunk, hash, index &#125;) =&gt; &#123;
          const formData = new FormData();
          formData.append(&quot;chunk&quot;, chunk);
          formData.append(&quot;hash&quot;, hash);
          formData.append(&quot;filename&quot;, this.container.file.name);
          formData.append(&quot;fileHash&quot;, this.container.hash);
          return &#123; formData, index &#125;;
        &#125;)
        .map(async (&#123; formData, index &#125;) =&gt;
          this.request(&#123;
            url: &quot;http://localhost:3001&quot;,
            data: formData,
            onProgress: this.createProgressHandler(this.data[index]),
            requestList: this.requestList
          &#125;)
        );
      await Promise.all(requestList);
      // ä¹‹å‰ä¸Šä¼ çš„åˆ‡ç‰‡æ•°é‡ + æœ¬æ¬¡ä¸Šä¼ çš„åˆ‡ç‰‡æ•°é‡ = æ‰€æœ‰åˆ‡ç‰‡æ•°é‡æ—¶
      // åˆå¹¶åˆ‡ç‰‡
      if (uploadedList.length + requestList.length === this.data.length) &#123;
        await this.mergeRequest();
      &#125;
    &#125;,
    // é€šçŸ¥æœåŠ¡ç«¯åˆå¹¶åˆ‡ç‰‡
    async mergeRequest() &#123;
      await this.request(&#123;
        url: &quot;http://localhost:3001/merge&quot;,
        headers: &#123;
          &quot;content-type&quot;: &quot;application/json&quot;
        &#125;,
        data: JSON.stringify(&#123;
          size: SIZE,
          fileHash: this.container.hash,
          filename: this.container.file.name
        &#125;)
      &#125;);
      this.$message.success(&quot;ä¸Šä¼ æˆåŠŸ&quot;);
      this.status = Status.wait;
    &#125;,
    // æ ¹æ® hash éªŒè¯æ–‡ä»¶æ˜¯å¦æ›¾ç»å·²ç»è¢«ä¸Šä¼ è¿‡
    // æ²¡æœ‰æ‰è¿›è¡Œä¸Šä¼ 
    async verifyUpload(filename, fileHash) &#123;
      const &#123; data &#125; = await this.request(&#123;
        url: &quot;http://localhost:3001/verify&quot;,
        headers: &#123;
          &quot;content-type&quot;: &quot;application/json&quot;
        &#125;,
        data: JSON.stringify(&#123;
          filename,
          fileHash
        &#125;)
      &#125;);
      return JSON.parse(data);
    &#125;,
    // ç”¨é—­åŒ…ä¿å­˜æ¯ä¸ª chunk çš„è¿›åº¦æ•°æ®
    createProgressHandler(item) &#123;
      return e =&gt; &#123;
        item.percentage = parseInt(String((e.loaded / e.total) * 100));
      &#125;;
    &#125;
  &#125;
&#125;;
&lt;/script&gt;
</code></pre>
</details></article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2022/02/23/http/" title="HTTPçš„è¯·æ±‚æ–¹æ³•ã€çŠ¶æ€ç "><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">ä¸Šä¸€é¡µ: HTTPçš„è¯·æ±‚æ–¹æ³•ã€çŠ¶æ€ç </span></a><a class="button is-default" href="/2022/01/24/image-host/" title="ä¸ªäººGitHubå›¾åºŠä½¿ç”¨webpæ ¼å¼çš„å›¾ç‰‡"><span class="has-text-weight-semibold">ä¸‹ä¸€é¡µ: ä¸ªäººGitHubå›¾åºŠä½¿ç”¨webpæ ¼å¼çš„å›¾ç‰‡</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/Jude"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- çŸ¥ä¹--><!-- é¢†è‹±--><!-- è„¸ä¹¦--></section><p><span>Copyright Â©</span><span> Jude 2022</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>